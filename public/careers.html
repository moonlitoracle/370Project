<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Careers - CareerRoadmap</title>
    <link rel="stylesheet" href="css/style.css">

</head>

<body>
    <header>
        <nav>
            <div class="logo">CareerRoadmap</div>
            <ul>
                <li><a href="dashboard.html">Dashboard</a></li>
                <li><a href="careers.html">Careers</a></li>
                <li><a href="goals.html">Goals</a></li>
                <li><a href="skill-management.html">Skills</a></li>
                <li><a href="skill-gap-analysis.html">Gap Analysis</a></li>
                <li><a href="progress-tracking.html">Progress</a></li>
                <li><a href="resources.html">Resources</a></li>
                <li><a href="#" id="logoutBtn" class="btn btn-secondary">Logout</a></li>
            </ul>
        </nav>
    </header>

    <main class="careers-container">
        <h1>Explore Career Paths ðŸš€</h1>

        <section>
            <h2>Available Careers</h2>
            <div id="careersList" class="careers-grid"></div>
        </section>

        <!-- Career Details Modal -->
        <div id="careerModal" class="modal" style="display: none;">
            <div class="modal-backdrop" onclick="closeCareerModal()"></div>
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="careerName"></h2>
                    <button class="modal-close" onclick="closeCareerModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <p id="careerOverview"></p>
                    <h3>Required Skills</h3>
                    <div id="requiredSkills"></div>
                </div>
                <div class="modal-footer">
                    <button id="selectCareerBtn" class="btn btn-primary">Select This Career</button>
                    <button class="btn btn-secondary" onclick="closeCareerModal()">Close</button>
                </div>
            </div>
        </div>
    </main>

    <footer>
        <p>&copy; 2025 CareerRoadmap. Empowering careers, one skill at a time.</p>
    </footer>

    <script src="js/app.js"></script>
    <script>
        let selectedCareerId = null;

        // Check authentication
        async function checkAuth() {
            const result = await Auth.checkSession();
            if (result.status !== 'success') {
                UI.redirect('login.html');
                return false;
            }
            return true;
        }

        // Load careers list
        async function loadCareers() {
            const result = await Career.list();
            if (result.status === 'success') {
                const careersList = document.getElementById('careersList');
                careersList.innerHTML = '';

                result.data.forEach(career => {
                    const careerCard = document.createElement('div');
                    careerCard.className = 'career-card';
                    const isSelected = career.is_selected == 1;
                    const badgeHtml = isSelected ? '<span class="badge-selected">Selected</span>' : '';

                    let btnHtml = '';
                    if (isSelected) {
                        btnHtml = `
                            <div style="display: flex; gap: 10px;">
                                <button class="btn btn-outline" onclick="viewCareerDetails(${career.career_id})">Details</button>
                                <button class="btn btn-primary" style="background: var(--color-error); border-color: var(--color-error);" onclick="removeCareer(${career.career_id}, '${career.name}')">Remove</button>
                            </div>
                        `;
                    } else {
                        btnHtml = `<button class="btn btn-primary" onclick="viewCareerDetails(${career.career_id})">View Details</button>`;
                    }

                    careerCard.innerHTML = `
                        <div style="display:flex; justify-content:space-between; align-items:start;">
                            <h3>${career.name}</h3>
                            ${badgeHtml}
                        </div>
                        <p>${career.overview || 'No description available'}</p>
                        ${btnHtml}
                    `;
                    careersList.appendChild(careerCard);
                });
            }
        }

        // View career details
        window.viewCareerDetails = async (careerId) => {
            console.log('View Details clicked for career ID:', careerId);

            try {
                const result = await Career.getDetails(careerId);
                console.log('API Result:', result);

                if (result.status === 'success') {
                    selectedCareerId = careerId;
                    const career = result.data;

                    document.getElementById('careerName').textContent = career.name;
                    document.getElementById('careerOverview').textContent = career.overview || 'No description available';

                    const skillsList = document.getElementById('requiredSkills');
                    skillsList.innerHTML = '';

                    if (career.required_skills && career.required_skills.length > 0) {
                        career.required_skills.forEach(skill => {
                            const skillTag = document.createElement('span');
                            skillTag.className = 'skill-tag';
                            skillTag.textContent = `${skill.name} (${skill.level})`;
                            skillsList.appendChild(skillTag);
                        });
                    } else {
                        skillsList.innerHTML = '<p>No specific skills required</p>';
                    }

                    const selectBtn = document.getElementById('selectCareerBtn');
                    // Clone button to remove old event listeners
                    const newBtn = selectBtn.cloneNode(true);
                    selectBtn.parentNode.replaceChild(newBtn, selectBtn);

                    if (career.is_selected) {
                        newBtn.textContent = 'Remove Career';
                        newBtn.disabled = false;
                        newBtn.classList.remove('btn-primary', 'btn-secondary');
                        newBtn.style.background = 'var(--color-error)';
                        newBtn.style.borderColor = 'var(--color-error)';
                        newBtn.onclick = () => removeCareer(careerId, career.name);
                    } else {
                        newBtn.textContent = 'Select This Career';
                        newBtn.disabled = false;
                        newBtn.classList.add('btn-primary');
                        newBtn.classList.remove('btn-secondary');
                        newBtn.style.background = ''; // Reset inline style
                        newBtn.style.borderColor = '';
                        newBtn.onclick = () => selectCareer(careerId);
                    }

                    document.getElementById('careerModal').style.display = 'flex';
                    // Prevent body scroll when modal is open
                    document.body.style.overflow = 'hidden';
                } else {
                    console.error('API Error:', result.message);
                    UI.showMessage('Error: ' + result.message, 'error');
                }
            } catch (error) {
                console.error('Failed to load career details:', error);
                UI.showMessage('Failed to load career details.', 'error');
            }
        };

        // Close career modal
        window.closeCareerModal = () => {
            document.getElementById('careerModal').style.display = 'none';
            document.body.style.overflow = 'auto';
        };

        // Select career
        async function selectCareer(careerId) {
            const result = await Career.select(careerId);
            if (result.status === 'success') {
                UI.showMessage('Career selected successfully! Refreshing...', 'success');
                setTimeout(() => window.location.reload(), 1500);
            } else {
                UI.showMessage(result.message, 'error');
            }
        }

        // Remove career
        window.removeCareer = async (careerId, careerName) => {
            if (!confirm(`Are you sure you want to remove "${careerName}" from your selected careers?`)) return;

            const result = await Career.remove(careerId);
            if (result.status === 'success') {
                UI.showMessage('Career removed successfully.', 'success');
                setTimeout(() => window.location.reload(), 1000);
            } else {
                UI.showMessage(result.message, 'error');
            }
        };

        // Old event listener removal (since we handle it dynamically now)
        // document.getElementById('selectCareerBtn').addEventListener... -> Removed

        // Logout handler
        document.getElementById('logoutBtn').addEventListener('click', async (e) => {
            e.preventDefault();
            const result = await Auth.logout();
            if (result.status === 'success') {
                UI.clearCurrentUser();
                UI.redirect('index.html');
            }
        });

        // Initialize
        (async () => {
            if (await checkAuth()) {
                await loadCareers();
            }
        })();
    </script>
</body>

</html>